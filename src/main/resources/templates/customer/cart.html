<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{customer/layout}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gi·ªè h√†ng | 4Petals</title>

<th:block layout:fragment="styles">
	<link rel="stylesheet" href="/styles/css/customer/base.css">
	<link rel="stylesheet" href="/styles/css/customer/cart.css">
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
</th:block>
</head>

<body>
	<div layout:fragment="content" class="home-page">

		<section class="cart-page">
			<!-- Toolbar: Select All -->
			<div class="cart-toolbar" style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding:8px 12px;background:#f7f7f8;border-radius:8px;">
				<input type="checkbox" id="selectAll">
				<label for="selectAll" style="user-select:none;cursor:pointer;font-weight:600;color:#444;">Ch·ªçn t·∫•t c·∫£</label>
			</div>
			<!-- üõí Danh s√°ch s·∫£n ph·∫©m -->
			<div class="cart-items">
				<!-- N·∫øu gi·ªè h√†ng tr·ªëng -->
				<div th:if="${#lists.isEmpty(items)}" class="empty-cart">
					<img src="/styles/image/customer/empty-cart.png" alt="Empty Cart">
					<h2>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h2>
					<p>H√£y ch·ªçn nh·ªØng b√≥ hoa xinh ƒë·∫πp ƒë·ªÉ l√†m ƒë·∫ßy gi·ªè h√†ng nh√© üíê</p>
					<a th:href="@{/product}" class="btn-continue">Ti·∫øp t·ª•c mua s·∫Øm</a>
				</div>

                <!-- L·∫∑p qua t·ª´ng CartItem -->
                <div th:each="c : ${items}" class="cart-item"
                     th:attr="data-id=${c.id},data-price=${c.product.price},data-promo=${c.product.promotionalPrice}">
                    <input type="checkbox" name="cartItem" class="selector" th:value="${c.id}" checked>

					<!-- ·∫¢nh s·∫£n ph·∫©m -->
					<img
						th:if="${c.product.images != null and !#lists.isEmpty(c.product.images)}"
						th:src="@{${c.product.images[0].imageUrl}}"
						th:alt="${c.product.productName}">

					<!-- ·∫£nh m·∫∑c ƒë·ªãnh n·∫øu s·∫£n ph·∫©m kh√¥ng c√≥ ·∫£nh -->
					<img
						th:if="${c.product.images == null or #lists.isEmpty(c.product.images)}"
						src="/styles/image/no-image.jpg" alt="No image available">

					<!-- Th√¥ng tin s·∫£n ph·∫©m -->
					<div class="info">
						<h4 th:text="${c.product.productName}">T√™n s·∫£n ph·∫©m</h4>
						<!-- Hi·ªÉn th·ªã gi√° khuy·∫øn m√£i n·∫øu c√≥, ng∆∞·ª£c l·∫°i hi·ªÉn th·ªã gi√° g·ªëc -->
						<div th:if="${c.product.promotionalPrice != null and c.product.promotionalPrice < c.product.price}">
							<p style="text-decoration: line-through; color: #999; font-size: 0.85em;"
								th:text="${#numbers.formatDecimal(c.product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</p>
							<p style="color: #e53935; font-weight: bold;"
								th:text="${#numbers.formatDecimal(c.product.promotionalPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</p>
						</div>
						<p th:unless="${c.product.promotionalPrice != null and c.product.promotionalPrice < c.product.price}"
							th:text="${#numbers.formatDecimal(c.product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</p>
					</div>

					<!-- S·ªë l∆∞·ª£ng -->
                    <div class="quantity">
						<button class="minus">‚àí</button>
                        <input type="number" min="1" th:value="${c.quantity}"
                            th:data-id="${c.id}">
						<button class="plus">+</button>
					</div>

					<!-- X√≥a -->
					<button class="remove" th:data-id="${c.id}">√ó</button>
				</div>
			</div>

			<!-- üí∞ T·ªïng c·ªông -->
			<div class="summary">
				<h3>Thanh to√°n</h3>
                <p>
                    T·∫°m t√≠nh: <span id="subtotalAmount" class="subtotal"
                        th:text="${#numbers.formatDecimal(subtotalOriginal != null ? subtotalOriginal : 0, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </p>
                <p id="discountRow">
                    Khuy·∫øn m√£i (
                    <span id="discountPercent"
                          th:text="${#numbers.formatDecimal(discountPercent, 0, 'COMMA', 0, 'POINT')}"></span>%):
                    <span id="discountAmount" style="color:#e53935; font-weight:600;"
                        th:text="'- ' + ${#numbers.formatDecimal(discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </p>
                <p class="total">
                    T·ªïng c·ªông: <strong id="totalAmount"
                        th:text="${#numbers.formatDecimal(finalTotal != null ? finalTotal : (subtotalOriginal - (discountAmount != null ? discountAmount : 0)), 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
                </p>

				<form id="checkoutForm" th:action="@{/checkout}" method="get">
					<input type="hidden" name="selectedIds" id="selectedIds">
					<button type="submit" class="checkout">Mua h√†ng</button>
				</form>
			</div>
		</section>

	</div>

    <th:block layout:fragment="scripts">
		<script src="/styles/js/customer/header.js"></script>
		<script th:src="@{/styles/js/customer/avatar.js}"></script>
        <script th:src="@{/styles/js/customer/cart.js}"></script>
        <script>
            (function() {
                const fmt = new Intl.NumberFormat('vi-VN');
                const selectAllEl = document.getElementById('selectAll');
                const subtotalEl = document.getElementById('subtotalAmount');
                const discountRow = document.getElementById('discountRow');
                const discountPercentEl = document.getElementById('discountPercent');
                const discountAmountEl = document.getElementById('discountAmount');
                const totalEl = document.getElementById('totalAmount');
                const selectedIdsEl = document.getElementById('selectedIds');

                function getNumber(v) {
                    if (v === null || v === undefined || v === '') return 0;
                    return Number(v);
                }

                function recalc() {
                    const items = Array.from(document.querySelectorAll('.cart-item'));
                    let subtotal = 0;
                    let discount = 0;
                    const selectedIds = [];

                    items.forEach(item => {
                        const checkbox = item.querySelector('input.selector');
                        const qtyInput = item.querySelector('.quantity input');
                        if (!checkbox || !qtyInput) return;
                        if (!checkbox.checked) return;
                        const id = item.getAttribute('data-id');
                        const price = getNumber(item.getAttribute('data-price'));
                        const promo = getNumber(item.getAttribute('data-promo'));
                        const qty = getNumber(qtyInput.value || 1);

                        const unit = (promo && promo > 0 && promo < price) ? promo : price;
                        subtotal += price * qty;
                        discount += Math.max(0, price - unit) * qty;
                        if (id) selectedIds.push(id);
                    });

                    const percent = subtotal > 0 ? Math.round((discount / subtotal) * 100) : 0;
                    const total = Math.max(0, subtotal - discount);

                    subtotalEl.textContent = fmt.format(Math.round(subtotal)) + ' ‚Ç´';
                    // Lu√¥n hi·ªÉn th·ªã khuy·∫øn m√£i, n·∫øu kh√¥ng ch·ªçn g√¨ th√¨ 0
                    discountPercentEl.textContent = fmt.format(percent);
                    discountAmountEl.textContent = '- ' + fmt.format(Math.round(discount)) + ' ‚Ç´';
                    totalEl.textContent = fmt.format(Math.round(total)) + ' ‚Ç´';
                    if (selectedIdsEl) selectedIdsEl.value = selectedIds.join(',');

                    // c·∫≠p nh·∫≠t tr·∫°ng th√°i select all
                    const selectors = Array.from(document.querySelectorAll('input.selector'));
                    if (selectors.length) {
                        const allChecked = selectors.every(cb => cb.checked);
                        const anyChecked = selectors.some(cb => cb.checked);
                        selectAllEl.checked = allChecked;
                        selectAllEl.indeterminate = !allChecked && anyChecked;
                    }
                }

                // events
                if (selectAllEl) {
                    selectAllEl.addEventListener('change', function() {
                        document.querySelectorAll('input.selector').forEach(cb => cb.checked = selectAllEl.checked);
                        recalc();
                    });
                }
                document.addEventListener('change', function(e) {
                    if (e.target.matches('input.selector') || e.target.matches('.quantity input')) {
                        recalc();
                    }
                });
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.plus') || e.target.closest('.minus')) {
                        setTimeout(recalc, 100);
                    }
                });

                // initial
                recalc();
            })();
        </script>
	</th:block>
</body>
</html>
