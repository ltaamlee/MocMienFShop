<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{customer/layout}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thanh to√°n</title>

<th:block layout:fragment="styles">
	<link rel="stylesheet" href="/styles/css/customer/base.css">
	<link rel="stylesheet" href="/styles/css/customer/checkout.css">
</th:block>
</head>
<body>
	<div layout:fragment="content" class="checkout-container">

		<!-- üå∏ ====== ƒê·ªäA CH·ªà NH·∫¨N H√ÄNG ====== -->
		<section class="address-section">
			<div class="address-header">
				<i class="fa fa-location-dot"></i>
				<h3>ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</h3>
			</div>

			<div class="address-info">
				<p class="receiver">
					<span class="name" id="selectedName"
						th:text="${defaultAddress != null ? defaultAddress.fullName : 'Ch∆∞a ch·ªçn ng∆∞·ªùi nh·∫≠n'}"></span>
					(<span class="phone" id="selectedPhone"
						th:text="${defaultAddress != null ? defaultAddress.phone : '---'}"></span>)
				</p>

				<p class="address" id="selectedAddress"
					th:text="${defaultAddress != null ? 
						(defaultAddress.line + ', ' + defaultAddress.ward + ', ' + 
						defaultAddress.district + ', ' + defaultAddress.province) 
						: 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng'}">
				</p>

				<a href="#" class="change-btn"
					th:text="${defaultAddress != null ? 'Thay ƒë·ªïi' : '+ Th√™m ƒë·ªãa ch·ªâ'}"></a>
			</div>
		</section>

		<!-- üõí ====== DANH S√ÅCH S·∫¢N PH·∫®M ====== -->
		<section class="cart-section">
			<h3>S·∫£n ph·∫©m</h3>
			<table class="cart-table">
				<thead>
					<tr>
						<th>S·∫£n ph·∫©m</th>
						<th>ƒê∆°n gi√°</th>
						<th>S·ªë l∆∞·ª£ng</th>
						<th>Th√†nh ti·ªÅn</th>
					</tr>
				</thead>
				<tbody th:if="${cartItems != null and !#lists.isEmpty(cartItems)}">
					<tr th:each="item : ${cartItems}">
						<td class="product-info">
							<img th:src="@{${item.product.images[0].imageUrl}}" alt="·∫¢nh s·∫£n ph·∫©m">
							<div>
								<div class="p-name" th:text="${item.product.productName}"></div>
								<div style="font-size: 0.8em; color: #666; margin-top: 4px;">
									<i class="fa-solid fa-box" style="color: #3b82f6;"></i> T·ªìn: <strong th:text="${item.product.stock != null ? item.product.stock : 0}">0</strong>
									| <i class="fa-solid fa-shopping-bag" style="color: #059669;"></i> ƒê√£ b√°n: <strong th:text="${item.product.sold != null ? item.product.sold : 0}">0</strong>
								</div>
							</div>
						</td>
						<td>
							<!-- Hi·ªÉn th·ªã gi√° khuy·∫øn m√£i n·∫øu c√≥ -->
							<span th:if="${item.product.promotionalPrice != null and item.product.promotionalPrice < item.product.price}">
								<del style="color: #999; font-size: 0.85em;" th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></del>
								<br/>
								<strong style="color: #e53935;" th:text="${#numbers.formatDecimal(item.product.promotionalPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
							</span>
							<span th:unless="${item.product.promotionalPrice != null and item.product.promotionalPrice < item.product.price}"
								th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
						</td>
						<td th:text="${item.quantity}"></td>
						<td>
							<!-- T√≠nh t·ªïng theo gi√° khuy·∫øn m√£i n·∫øu c√≥ -->
							<strong th:if="${item.product.promotionalPrice != null and item.product.promotionalPrice < item.product.price}"
								style="color: #e53935;"
								th:text="${#numbers.formatDecimal(item.product.promotionalPrice * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
							<strong th:unless="${item.product.promotionalPrice != null and item.product.promotionalPrice < item.product.price}"
								th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
						</td>
					</tr>
				</tbody>
				<tbody th:if="${#lists.isEmpty(cartItems)}">
					<tr>
						<td colspan="4" style="text-align: center;">Kh√¥ng c√≥ s·∫£n ph·∫©m
							n√†o ƒë·ªÉ thanh to√°n.</td>
					</tr>
				</tbody>
			</table>

			<div class="cart-summary" th:if="${!#lists.isEmpty(cartItems)}">
				<p>
					T·ªïng ti·ªÅn (<span th:text="${#lists.size(cartItems)}">0</span> s·∫£n
					ph·∫©m): <strong
						th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
				</p>
			</div>
		</section>

		<!-- üí≥ ====== PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ====== -->
		<section class="payment-section">
			<h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
			<div class="payment-options">
				<label class="payment-tab active"> <input type="radio"
					name="paymentMethod" value="COD" checked> <img
					src="/styles/image/icons/cash-on-delivery.png" alt="COD"
					class="payment-icon"> <span>Thanh to√°n khi nh·∫≠n h√†ng
						(Ship COD)</span>
				</label> <label class="payment-tab"> <input type="radio"
					name="paymentMethod" value="QR"> <img
					src="/styles/image/icons/momo.svg" alt="MoMo" class="payment-icon">
					<span>Thanh to√°n Online (MoMo)</span>
				</label>
			</div>

			<!-- üßæ ====== T·ªîNG K·∫æT & N√öT ƒê·∫∂T H√ÄNG ====== -->
			<div class="payment-summary">
				<div class="summary-line">
					<span>T·ªïng ti·ªÅn h√†ng</span> <span
						th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
				</div>
				<div class="summary-line">
					<span>Ph√≠ v·∫≠n chuy·ªÉn</span> <span
						th:text="${#numbers.formatDecimal(shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
				</div>
				<div class="summary-line total">
					<span>T·ªïng thanh to√°n</span> <strong
						th:text="${grandTotal != null ? #numbers.formatDecimal(grandTotal.doubleValue(), 0, 'COMMA', 0, 'POINT') : '0'} + ' ‚Ç´'"></strong>
				</div>

				<form th:action="@{/checkout/confirm}" method="post"
					id="checkoutForm">
					<input type="hidden" name="receiver"
						th:value="${defaultAddress != null ? defaultAddress.fullName : ''}">
					<input type="hidden" name="phone"
						th:value="${defaultAddress != null ? defaultAddress.phone : ''}">
					<input type="hidden" name="address"
						th:value="${defaultAddress != null ? 
							(defaultAddress.line + ', ' + defaultAddress.ward + ', ' + 
							defaultAddress.district + ', ' + defaultAddress.province) 
							: ''}">

					<!-- Mua ngay -->
					<input type="hidden" name="productId" th:value="${param.productId}">
					<input type="hidden" name="quantity" th:value="${param.quantity}">

					<!-- Mua t·ª´ gi·ªè h√†ng -->
					<input type="hidden" id="cartItemIds" name="cartItemIds"
						th:value="${param.selectedIds}" />


					<!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
					<input type="hidden" name="paymentMethod" id="paymentMethodInput"
						value="COD">

					<button type="submit" class="btn-order">ƒê·∫∑t h√†ng</button>
				</form>
			</div>
		</section>

		<!-- üå∏ Modal ch·ªçn ƒë·ªãa ch·ªâ -->
		<div id="addressModal" class="modal hidden">
			<div class="modal-content address-list-popup">
				<h3>ƒê·ªãa Ch·ªâ C·ªßa T√¥i</h3>
				<ul id="addressList" class="address-list">
					<li th:each="addr : ${addresses}"><label> <input
							type="radio" name="selectedAddress" th:value="${addr.id}">
							<div>
								<strong th:text="${addr.fullName}"></strong> (<span
									th:text="${addr.phone}"></span>)<br> <span
									th:text="${addr.line + ', ' + addr.ward + ', ' + addr.district + ', ' + addr.province}"></span>
							</div>
					</label> <a href="#" class="update-btn" th:data-id="${addr.id}">C·∫≠p
							nh·∫≠t</a></li>
				</ul>

				<button type="button" id="openAddAddressBtn" class="btn-add">+
					Th√™m ƒê·ªãa Ch·ªâ M·ªõi</button>

				<div class="actions">
					<button type="button" id="cancelAddressBtn" class="btn-cancel">H·ªßy</button>
					<button type="button" id="confirmAddressBtn" class="btn-confirm">X√°c
						nh·∫≠n</button>
				</div>
			</div>
		</div>

		<!-- üå∏ Modal th√™m ƒë·ªãa ch·ªâ -->
		<div id="addAddressModal" class="modal hidden">
			<div class="modal-content">
				<h3>ƒê·ªãa ch·ªâ m·ªõi</h3>
				<form id="addAddressForm">
					<div class="row">
						<input type="text" id="newFullName" placeholder="H·ªç v√† t√™n"
							required> <input type="text" id="newPhone"
							placeholder="S·ªë ƒëi·ªán tho·∫°i" required pattern="[0-9]{9,11}">
					</div>
					<div class="form-group">
						<label>ƒê·ªãa ch·ªâ</label> <select id="province"><option>Ch·ªçn
								T·ªânh/TP</option></select> <select id="district"><option>Ch·ªçn
								Qu·∫≠n/Huy·ªán</option></select> <select id="ward"><option>Ch·ªçn
								Ph∆∞·ªùng/X√£</option></select>
					</div>
					<textarea id="newDetailAddress" rows="2"
						placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ" required></textarea>

					<div class="form-actions">
						<button type="button" id="cancelAddAddressBtn" class="btn-cancel">Tr·ªü
							l·∫°i</button>
						<button type="submit" class="btn-save">Ho√†n th√†nh</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<th:block layout:fragment="scripts">
		<script src="/styles/js/customer/header.js"></script>
		<script src="/styles/js/customer/checkout.js"></script>
	</th:block>
</body>
</html>
